#!/bin/bash -e
# Copyright 2012-2022 Michael Pozhidaev <msp@luwrain.org>
# The LUWRAIN Project, GPL v.3

. config.sh

TEMP_DIR=$(mktemp -d /tmp/.nightly-XXXXXX)

if [ "$1" == '--tmpfs' ]; then
    echo "Creating tmpfs at $TEMP_DIR"
    sudo mount -t tmpfs -o size=20g tmpfs "$TEMP_DIR"
else
    echo "Working in $TEMP_DIR"
fi

rm -f /tmp/nightly
ln -s $TEMP_DIR /tmp/nightly

cd $TEMP_DIR

echo 'Downloading files'
git clone https://github.com/luwrain/parent/ --recursive &> log-fetch
mv parent src
cd src/base/scripts
./lwr-prepare &>> ../../../log-fetch

DEST="luwrain-nightly-`date -I`"
./lwr-dist-src $TEMP_DIR/$DEST
pushd "$TEMP_DIR" > /dev/null
echo "Processing $DEST"
tar -c "$DEST/" | xz > "$DEST.tar.xz"
sha1sum "$DEST.tar.xz" > sha1.txt
popd > /dev/null

echo Compiling sources
./lwr-build &> ../../../log.txt

echo Building the main distribution
./lwr-dist-linux $TEMP_DIR/linux
#./lwr-dist-iso $TEMP_DIR/iso
./lwr-dist-win $TEMP_DIR/win
# General Linux
for i in x64; do
    DEST=luwrain-linux-"$i"-nightly-"`date -I`"
    echo "Processing $DEST"
    mv "$TEMP_DIR/linux/$i" "$TEMP_DIR/$DEST"
    pushd "$TEMP_DIR" > /dev/null
    tar -c "$DEST/" | xz > "$DEST.tar.xz"
    sha1sum "$DEST.tar.xz" >> sha1.txt
    popd > /dev/null
done
rmdir "$TEMP_DIR/linux"
# General Windows
for i in x64; do
    DEST=luwrain-windows-"$i"-nightly-"`date -I`"
    echo "Processing $DEST"
    mv "$TEMP_DIR/win/$i" "$TEMP_DIR/$DEST"
    pushd "$TEMP_DIR" > /dev/null
    zip -r "$DEST.zip" "$DEST" > /dev/null
    sha1sum "$DEST.zip" >> sha1.txt
    popd > /dev/null
done
for i in x64; do
    DEST=luwrain-windows-installer-"$i"-nightly-"`date -I`"
    echo "Processing $DEST"
    mv "$TEMP_DIR/win/installer-$i" "$TEMP_DIR/$DEST"
    pushd "$TEMP_DIR" > /dev/null
    zip -r "$DEST.zip" "$DEST" > /dev/null
    sha1sum "$DEST.zip" >> sha1.txt
    popd > /dev/null
done
rmdir $TEMP_DIR/win



#echo Building books
##./lwr-custom-books-linux $TEMP_DIR/linux $TEMP_DIR/books-linux
##./lwr-custom-books-win $TEMP_DIR/win $TEMP_DIR/books-win

#echo Building education
#./lwr-custom-education-linux $TEMP_DIR/linux $TEMP_DIR/education-linux
#./lwr-custom-education-win $TEMP_DIR/win $TEMP_DIR/education-win

#echo Building dl
##./lwr-custom-dl-linux $TEMP_DIR/linux $TEMP_DIR/dl-linux
#./lwr-custom-dl-win $TEMP_DIR/win $TEMP_DIR/dl-win

#echo Building anatomy
#./lwr-custom-anatomy-win $TEMP_DIR/win $TEMP_DIR/anatomy-win

#echo Building DM
#./lwr-custom-dm-linux $TEMP_DIR/linux $TEMP_DIR/dm-linux
#./lwr-custom-dm-win $TEMP_DIR/win $TEMP_DIR/dm-win

#echo Building TsuLib
#./lwr-custom-tsulib-linux $TEMP_DIR/linux $TEMP_DIR/tsulib-linux
#./lwr-custom-tsulib-win $TEMP_DIR/win $TEMP_DIR/tsulib-win

# ISO
#DEST=luwrain-iso-nightly-"`date -I`"
#echo "Processing $DEST"
#mv "$TEMP_DIR/iso" "$TEMP_DIR/$DEST"
#pushd "$TEMP_DIR" > /dev/null
#tar -c "$DEST/" | gzip > "$DEST.tar.gz"
#sha1sum "$DEST.tar.gz" >> sha1.txt
#rm -rf "$TEMP_DIR/$DEST"


# Books linux
#for i in $LINUX_ARCH; do
#    DEST=books-linux-"$i"bit-nightly-"`date -I`"
#    echo "Processing $DEST"
#    mv "$TEMP_DIR/books-linux/$i" "$TEMP_DIR/$DEST"
#    pushd "$TEMP_DIR" > /dev/null
#    tar -c "$DEST/" | gzip > "$DEST.tar.gz"
#    sha1sum "$DEST.tar.gz" >> sha1.txt
#    popd > /dev/null
#done
#rmdir "$TEMP_DIR/books-linux"

# Education linux
#for i in $LINUX_ARCH; do
#    DEST=education-linux-"$i"bit-nightly-"`date -I`"
#    echo "Processing $DEST"
#    mv "$TEMP_DIR/education-linux/$i" "$TEMP_DIR/$DEST"
#    pushd "$TEMP_DIR" > /dev/null
#    tar -c "$DEST/" | gzip > "$DEST.tar.gz"
#    sha1sum "$DEST.tar.gz" >> sha1.txt
#    popd > /dev/null
#done
#rmdir "$TEMP_DIR/education-linux"

# DM linux
#for i in $LINUX_ARCH; do
#    DEST=dm-linux-"$i"bit-nightly-"`date -I`"
#    echo "Processing $DEST"
#    mv "$TEMP_DIR/dm-linux/$i" "$TEMP_DIR/$DEST"
#    pushd "$TEMP_DIR" > /dev/null
#    tar -c "$DEST/" | gzip > "$DEST.tar.gz"
#    sha1sum "$DEST.tar.gz" >> sha1.txt
#    popd > /dev/null
#done
#rmdir "$TEMP_DIR/dm-linux"

# TsuLib linux
#for i in $LINUX_ARCH; do
#    DEST=tsulib-linux-"$i"bit-nightly-"`date -I`"
#    echo "Processing $DEST"
#    mv "$TEMP_DIR/tsulib-linux/$i" "$TEMP_DIR/$DEST"
#    pushd "$TEMP_DIR" > /dev/null
#    tar -c "$DEST/" | gzip > "$DEST.tar.gz"
#    sha1sum "$DEST.tar.gz" >> sha1.txt
#    popd > /dev/null
#done
#rmdir "$TEMP_DIR/tsulib-linux"


# Books windows
#for i in 32 64; do
#    DEST=books-windows-"$i"bit-nightly-"`date -I`"
#    echo "Processing $DEST"
#    mv "$TEMP_DIR/books-win/$i" "$TEMP_DIR/$DEST"
#    pushd "$TEMP_DIR" > /dev/null
#    zip -r "$DEST.zip" "$DEST" > /dev/null
#    sha1sum "$DEST.zip" >> sha1.txt
#    popd > /dev/null
#done
#for i in 32 64; do
#    DEST=books-windows-installer-"$i"bit-nightly-"`date -I`"
#    echo "Processing $DEST"
#    mv "$TEMP_DIR/books-win/installer$i" "$TEMP_DIR/$DEST"
#    pushd "$TEMP_DIR" > /dev/null
#    zip -r "$DEST.zip" "$DEST" > /dev/null
#    sha1sum "$DEST.zip" >> sha1.txt
#    popd > /dev/null
#done
#rmdir "$TEMP_DIR/books-win"

# DL Windows
#for i in 32 64; do
#    DEST=dl-windows-"$i"bit-nightly-"`date -I`"
#    echo "Processing $DEST"
#    mv "$TEMP_DIR/dl-win/$i" "$TEMP_DIR/$DEST"
#    pushd "$TEMP_DIR" > /dev/null
#    zip -r "$DEST.zip" "$DEST" > /dev/null
#    sha1sum "$DEST.zip" >> sha1.txt
#    popd > /dev/null
#done
#for i in 32 64; do
#    DEST=dl-windows-installer-"$i"bit-nightly-"`date -I`"
#    echo "Processing $DEST"
#    mv "$TEMP_DIR/dl-win/installer$i" "$TEMP_DIR/$DEST"
#    pushd "$TEMP_DIR" > /dev/null
#    zip -r "$DEST.zip" "$DEST" > /dev/null
#    sha1sum "$DEST.zip" >> sha1.txt
#    popd > /dev/null
#done
#rmdir "$TEMP_DIR/dl-win"

# Education windows
#for i in 32 64; do
#    DEST=education-windows-"$i"bit-nightly-"`date -I`"
#    echo "Processing $DEST"
#    mv "$TEMP_DIR/education-win/$i" "$TEMP_DIR/$DEST"
#    pushd "$TEMP_DIR" > /dev/null
#    zip -r "$DEST.zip" "$DEST" > /dev/null
#    sha1sum "$DEST.zip" >> sha1.txt
#    popd > /dev/null
#done
#for i in 32 64; do
#    DEST=education-windows-installer-"$i"bit-nightly-"`date -I`"
#    echo "Processing $DEST"
#    mv "$TEMP_DIR/education-win/installer$i" "$TEMP_DIR/$DEST"
#    pushd "$TEMP_DIR" > /dev/null
#    zip -r "$DEST.zip" "$DEST" > /dev/null
#    sha1sum "$DEST.zip" >> sha1.txt
#    popd > /dev/null
#done
#rmdir "$TEMP_DIR/education-win"

#tsulib windows
#for i in 32 64; do
#    DEST=tsulib-windows-"$i"bit-nightly-"`date -I`"
#    echo "Processing $DEST"
#    mv "$TEMP_DIR/tsulib-win/$i" "$TEMP_DIR/$DEST"
#    pushd "$TEMP_DIR" > /dev/null
#    zip -r "$DEST.zip" "$DEST" > /dev/null
#    sha1sum "$DEST.zip" >> sha1.txt
#    popd > /dev/null
#done
#for i in 32 64; do
#    DEST=tsulib-windows-installer-"$i"bit-nightly-"`date -I`"
#    echo "Processing $DEST"
#    mv "$TEMP_DIR/tsulib-win/installer$i" "$TEMP_DIR/$DEST"
#    pushd "$TEMP_DIR" > /dev/null
#    zip -r "$DEST.zip" "$DEST" > /dev/null
#    sha1sum "$DEST.zip" >> sha1.txt
#    popd > /dev/null
#done
#rmdir "$TEMP_DIR/tsulib-win"

#dm windows
#for i in 32 64; do
#    DEST=dm-windows-"$i"bit-nightly-"`date -I`"
#    echo "Processing $DEST"
#    mv "$TEMP_DIR/dm-win/$i" "$TEMP_DIR/$DEST"
#    pushd "$TEMP_DIR" > /dev/null
#    zip -r "$DEST.zip" "$DEST" > /dev/null
#    sha1sum "$DEST.zip" >> sha1.txt
#    popd > /dev/null
#done
#for i in 32 64; do
#    DEST=dm-windows-installer-"$i"bit-nightly-"`date -I`"
#    echo "Processing $DEST"
#    mv "$TEMP_DIR/dm-win/installer$i" "$TEMP_DIR/$DEST"
#    pushd "$TEMP_DIR" > /dev/null
#    zip -r "$DEST.zip" "$DEST" > /dev/null
#    sha1sum "$DEST.zip" >> sha1.txt
#    popd > /dev/null
#done
#rmdir "$TEMP_DIR/dm-win"

#anatomy windows
#for i in 64; do
#    DEST=anatomy-windows-"$i"bit-nightly-"`date -I`"
#    echo "Processing $DEST"
#    mv "$TEMP_DIR/anatomy-win/$i" "$TEMP_DIR/$DEST"
#    pushd "$TEMP_DIR" > /dev/null
#    zip -r "$DEST.zip" "$DEST" > /dev/null
#    sha1sum "$DEST.zip" >> sha1.txt
#    popd > /dev/null
#done
#for i in 64; do
#    DEST=anatomy-windows-installer-"$i"bit-nightly-"`date -I`"
#    echo "Processing $DEST"
#    mv "$TEMP_DIR/anatomy-win/installer$i" "$TEMP_DIR/$DEST"
#    pushd "$TEMP_DIR" > /dev/null
#    zip -r "$DEST.zip" "$DEST" > /dev/null
#    sha1sum "$DEST.zip" >> sha1.txt
#    popd > /dev/null
#done
#    rmdir "$TEMP_DIR/anatomy-win"

cd "$TEMP_DIR"
RELEASE_DIR=~/nightly-`date -I`
if [ -d "$RELEASE_DIR" ]; then
    echo "${0##*/}:$RELEASE_DIR exists, skipping its creation"
    exit 0
fi

mkdir -p "$RELEASE_DIR"
mv *.txt *.xz *.zip "$RELEASE_DIR"
if [ -r /tmp/lwr-report/junit-noframes.html ]; then
    cp /tmp/lwr-report/junit-noframes.html "$RELEASE_DIR/junit-report.html"
fi
rm -f "$RELEASE_DIR/log.txt"

cat <<EOF > "$RELEASE_DIR/version.php"
<?php
function lwr_nightly_latest_date()
{
return "$(date -I)";
}
?>
EOF

echo 'OK!'
